#### SE CARGAN LOS ARCHIVOS ####
library(readr)

Galaxy388 <- read_delim("counts de RNA STAR/388a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy396 <- read_delim("counts de RNA STAR/396a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy400 <- read_delim("counts de RNA STAR/400a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy404 <- read_delim("counts de RNA STAR/404a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy408 <- read_delim("counts de RNA STAR/408a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy412 <- read_delim("counts de RNA STAR/412a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy416 <- read_delim("counts de RNA STAR/416a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy420 <- read_delim("counts de RNA STAR/420a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy424 <- read_delim("counts de RNA STAR/424a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy428 <- read_delim("counts de RNA STAR/428a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy432 <- read_delim("counts de RNA STAR/432a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy436 <- read_delim("counts de RNA STAR/436a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy440 <- read_delim("counts de RNA STAR/440a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy444 <- read_delim("counts de RNA STAR/444a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy448 <- read_delim("counts de RNA STAR/448a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy452 <- read_delim("counts de RNA STAR/452a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy456 <- read_delim("counts de RNA STAR/456a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy460 <- read_delim("counts de RNA STAR/460a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy464 <- read_delim("counts de RNA STAR/464a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy468 <- read_delim("counts de RNA STAR/468a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy472 <- read_delim("counts de RNA STAR/472a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy476 <- read_delim("counts de RNA STAR/476a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy480 <- read_delim("counts de RNA STAR/480a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy484 <- read_delim("counts de RNA STAR/484a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy488 <- read_delim("counts de RNA STAR/488a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy492 <- read_delim("counts de RNA STAR/492a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy496 <- read_delim("counts de RNA STAR/496a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy500 <- read_delim("counts de RNA STAR/500a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy504 <- read_delim("counts de RNA STAR/504a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy508 <- read_delim("counts de RNA STAR/508a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy512 <- read_delim("counts de RNA STAR/512a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy516 <- read_delim("counts de RNA STAR/516a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy520 <- read_delim("counts de RNA STAR/520a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy524 <- read_delim("counts de RNA STAR/524a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy528 <- read_delim("counts de RNA STAR/528a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy536 <- read_delim("counts de RNA STAR/536a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy540 <- read_delim("counts de RNA STAR/540a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy544 <- read_delim("counts de RNA STAR/544a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy548 <- read_delim("counts de RNA STAR/548a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy552 <- read_delim("counts de RNA STAR/552a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy556 <- read_delim("counts de RNA STAR/556a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy560 <- read_delim("counts de RNA STAR/560a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy564 <- read_delim("counts de RNA STAR/564a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy568 <- read_delim("counts de RNA STAR/568a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy572 <- read_delim("counts de RNA STAR/572a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy576 <- read_delim("counts de RNA STAR/576a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy580 <- read_delim("counts de RNA STAR/580a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

Galaxy592 <- read_delim("counts de RNA STAR/592a.tabular", 
                        delim = "\t", escape_double = FALSE, 
                        col_names = FALSE, trim_ws = TRUE, skip = 4)

#### SE ELIMINAN COLUMNAS INNECESARIAS ####

gal388 <- Galaxy388[,1:2]
gal396 <- Galaxy396[,1:2]
gal400 <- Galaxy400[,1:2]
gal404 <- Galaxy404[,1:2]
gal408 <- Galaxy408[,1:2]
gal412 <- Galaxy412[,1:2]
gal416 <- Galaxy416[,1:2]
gal420 <- Galaxy420[,1:2]
gal424 <- Galaxy424[,1:2]
gal428 <- Galaxy428[,1:2]
gal432 <- Galaxy432[,1:2]
gal436 <- Galaxy436[,1:2]
gal440 <- Galaxy440[,1:2]
gal444 <- Galaxy444[,1:2]
gal448 <- Galaxy448[,1:2]
gal452 <- Galaxy452[,1:2]
gal456 <- Galaxy456[,1:2]
gal460 <- Galaxy460[,1:2]
gal464 <- Galaxy464[,1:2]
gal468 <- Galaxy468[,1:2]
gal472 <- Galaxy472[,1:2]
gal476 <- Galaxy476[,1:2]
gal480 <- Galaxy480[,1:2]
gal484 <- Galaxy484[,1:2]
gal488 <- Galaxy488[,1:2]
gal492 <- Galaxy492[,1:2]
gal496 <- Galaxy496[,1:2]
gal500 <- Galaxy500[,1:2]
gal504 <- Galaxy504[,1:2]
gal508 <- Galaxy508[,1:2]
gal512 <- Galaxy512[,1:2]
gal516 <- Galaxy516[,1:2]
gal520 <- Galaxy520[,1:2]
gal524 <- Galaxy524[,1:2]
gal528 <- Galaxy528[,1:2]
gal536 <- Galaxy536[,1:2]
gal540 <- Galaxy540[,1:2]
gal544 <- Galaxy544[,1:2]
gal548 <- Galaxy548[,1:2]
gal552 <- Galaxy552[,1:2]
gal556 <- Galaxy556[,1:2]
gal560 <- Galaxy560[,1:2]
gal564 <- Galaxy564[,1:2]
gal568 <- Galaxy568[,1:2]
gal572 <- Galaxy572[,1:2]
gal576 <- Galaxy576[,1:2]
gal580 <- Galaxy580[,1:2]
gal592 <- Galaxy592[,1:2]

#### SE ORDENAN LOS OBJETOS ####

gal388 <- gal388[order(gal388$X1),]
gal396 <- gal396[order(gal396$X1),]
gal400 <- gal400[order(gal400$X1),]
gal404 <- gal404[order(gal404$X1),]
gal408 <- gal408[order(gal408$X1),]
gal412 <- gal412[order(gal412$X1),]
gal416 <- gal416[order(gal416$X1),]
gal420 <- gal420[order(gal420$X1),]
gal424 <- gal424[order(gal424$X1),]
gal428 <- gal428[order(gal428$X1),]
gal432 <- gal432[order(gal432$X1),]
gal436 <- gal436[order(gal436$X1),]
gal440 <- gal440[order(gal440$X1),]
gal444 <- gal444[order(gal444$X1),]
gal448 <- gal448[order(gal448$X1),]
gal452 <- gal452[order(gal452$X1),]
gal456 <- gal456[order(gal456$X1),]
gal460 <- gal460[order(gal460$X1),]
gal464 <- gal464[order(gal464$X1),]
gal468 <- gal468[order(gal468$X1),]
gal472 <- gal472[order(gal472$X1),]
gal476 <- gal476[order(gal476$X1),]
gal480 <- gal480[order(gal480$X1),]
gal484 <- gal484[order(gal484$X1),]
gal488 <- gal488[order(gal488$X1),]
gal492 <- gal492[order(gal492$X1),]
gal496 <- gal496[order(gal496$X1),]
gal500 <- gal500[order(gal500$X1),]
gal504 <- gal504[order(gal504$X1),]
gal508 <- gal508[order(gal508$X1),]
gal512 <- gal512[order(gal512$X1),]
gal516 <- gal516[order(gal516$X1),]
gal520 <- gal520[order(gal520$X1),]
gal524 <- gal524[order(gal524$X1),]
gal528 <- gal528[order(gal528$X1),]
gal536 <- gal536[order(gal536$X1),]
gal540 <- gal540[order(gal540$X1),]
gal544 <- gal544[order(gal544$X1),]
gal548 <- gal548[order(gal548$X1),]
gal552 <- gal552[order(gal552$X1),]
gal556 <- gal556[order(gal556$X1),]
gal560 <- gal560[order(gal560$X1),]
gal564 <- gal564[order(gal564$X1),]
gal568 <- gal568[order(gal568$X1),]
gal572 <- gal572[order(gal572$X1),]
gal576 <- gal576[order(gal576$X1),]
gal580 <- gal580[order(gal580$X1),]
gal592 <- gal592[order(gal592$X1),]

#### SE UNEN LOS RESULTADOS OBTENIDOS PARA OBTENER UNA MATRIZ UNICA ####

c <- cbind(gal388,gal396)
d <- cbind(c, gal400)
e <- cbind(d, gal404)
f <- cbind(e, gal408)
g <- cbind(f, gal412)
h <- cbind(g, gal416)
i <- cbind(h, gal420)
j <- cbind(i, gal424)
k <- cbind(j, gal428)
l <- cbind(k, gal432)
m <- cbind(l, gal436)
n <- cbind(m, gal440)
o <- cbind(n, gal444)
p <- cbind(o, gal448)
q <- cbind(p, gal452)
r <- cbind(q, gal456)
s <- cbind(r, gal460)
t <- cbind(s, gal464)
u <- cbind(t, gal468)
v <- cbind(u, gal472)
w <- cbind(v, gal476)
x <- cbind(w, gal480)
y <- cbind(x, gal484)
z <- cbind(y, gal488)
a1 <- cbind(z, gal492)
b1 <- cbind(a1, gal496)
c1 <- cbind(b1, gal500)
d1 <- cbind(c1, gal504)
e1 <- cbind(d1, gal508)
f1 <- cbind(e1, gal512)
g1 <- cbind(f1, gal516)
h1 <- cbind(g1, gal520)
i1 <- cbind(h1, gal524)
j1 <- cbind(i1, gal528)
l1 <- cbind(j1, gal536)
m1 <- cbind(l1, gal540)
n1 <- cbind(m1, gal544)
o1 <- cbind(n1, gal548)
p1 <- cbind(o1, gal552)
q1 <- cbind(p1, gal556)
r1 <- cbind(q1, gal560)
s1 <- cbind(r1, gal564)
t1 <- cbind(s1, gal568)
u1 <- cbind(t1, gal572)
v1 <- cbind(u1, gal576)
w1 <- cbind(v1, gal580)
x1 <- cbind(w1, gal592)

#### SE LE CAMBIA EL NOMBRE A LAS MUESTRAS PARA QUE SEA MAS COMODO TRABAJAR CON ELLAS ####

library(dplyr)

colnames(x1) <- make.names(1:ncol(x1))

matriz_test <- select(x1, X1, X2, X4, X6, X8, X10, X12, X14, X16, X18, X20, X22, X24, X26, X28, 
                      X30, X32, X34, X36, X38, X40, X42, X44, X46, X48, X50, X52, X54, X56, X58, 
                      X60, X62, X64, X66, X68, X70, X72, X74, X76, X78, X80, X82, X84, X86, X88,
                      X90, X92, X94, X96)

rownames(matriz_test) <- matriz_test$X1

matriz_contajes <- select(matriz_test, -X1)

# Relacionamos el codigo con el gen

library(biomaRt)
# Seleccionamos la base de datos de partida
mart <- useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
# Se obtienen los nombres correspondientes a cada id. 
rna_id <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"), filters = "ensembl_gene_id_version", values = matriz_test$X1, mart = mart)


#### SE LE ASIGNA EL GRUPO A CADA MUESTRA ####

grupos_muestras <- read_delim("grupos_muestras.csv", 
                              delim = ";", escape_double = FALSE, trim_ws = TRUE)
grupos_muestras <- as.data.frame(grupos_muestras)
rownames(grupos_muestras) <- grupos_muestras$X1000
grupos_muestras <- grupos_muestras[,-1]
grupos_muestras_factor <- as.factor(grupos_muestras)

# Union de los grupos a la matriz de contaje

union <- rbind(matriz_contajes, grupos_muestras)
union_t <- as.data.frame(t(union))

# Se crean subsets para cada clase

basal <- subset(union_t, union_t$grupo=="Basal")
post <- subset(union_t, union_t$grupo=="Post")
rec <- subset(union_t, union_t$grupo=="Rec")

#### FILTRO DE LOS GENES MENOS EXPRESADOS ####

library(edgeR)

# Contajes de todas las muestras
colSums(matriz_contajes)

# Valores de recuento por millon
counts_CPM <- cpm(matriz_contajes)
head(counts_CPM)

# Nos quedamos con los genes que se expresan a un CPM superior a 0.5
# Umbral de corte - Matriz booleana para el filtraje
thresh <- counts_CPM > 0.5
head(thresh)

# ¿Donde establecemos el corte?¿Como minimo cuantos verdaderos?

lista_dge <- DGEList(matriz_contajes, group = grupos_muestras_factor)
keep <- filterByExpr(lista_dge)
#keep_2 <- filterByExpr(lista_dge, min.count=7)

# Subconjunto de las filas de datos de conteo para mantener los genes mas expresados

counts_keep <- matriz_contajes[keep,]
#counts_keep2 <- matriz_contajes[keep_2,]
dim(matriz_contajes)
dim(counts_keep)

#### CLASES ESPECIFICAS PARA MANEJAR LOS DATOS ####

# Lista para almacenar recuentos de reads
dgeObj <- DGEList(counts_keep)
dgeObj

names(dgeObj)

# ¿Donde se almacena la informacion del tamaño de la biblioteca?

dgeObj$samples

#### EXPLORACION DE LOS DATOS ####

# Boxplot de los recuentos no normalizados

logcounts <- cpm(dgeObj, log=TRUE) # Log2 counts por millon
boxplot(logcounts, ylab = "Log2-CPM", las = 2, xlab = "", cex.axis=0.8, main = "Boxplot de logCPMs sin normalizar")
abline(h=median(logcounts), col="red")

# Normalizacion
# Se calculan los factores de normalizacion
dgeObj_norm <- calcNormFactors(dgeObj)
dgeObj_norm

# Se repite el grafico pero con los contajes normalizados (se espera que sean mas comparables)

logcounts_norm <- cpm(dgeObj_norm, log=TRUE) # Log2 counts por millon
boxplot(logcounts_norm, ylab = "Log2-CPM", las = 2, xlab = "", cex.axis=0.8, main = "Boxplot de logCPMs normalizados")
abline(h=median(logcounts_norm), col="red")

#### CALCULO DE LOS P-VALORES - WILCOX TEST ####

wilcox_prueba <- apply(logcounts_norm, 1, function(x) pairwise.wilcox.test(x, grupos_muestras_factor, p.adjust.method = "fdr", paired = TRUE)$p.value)
#pairwise.wilcox.test(logcounts_norm[2,], grupos_muestras_factor, p.adjust.method = "none")
wilcox_prueba2 <- t(wilcox_prueba)
wilcox_prueba2_df <- as.data.frame(wilcox_prueba2)
wil <- wilcox_prueba2[which(wilcox_prueba2[,1]<=0.05),1]
wil_basal_post <- as.data.frame(wil)
wil2 <- wilcox_prueba2[which(wilcox_prueba2[,2]<=0.05),2]
wil_basal_rec <- as.data.frame(wil2)
wil3 <- wilcox_prueba2[which(wilcox_prueba2[,4]<=0.05),4]
wil_post_rec <- as.data.frame(wil3)

###### TEST FOLD CHANGE ######

basal_numeric <- apply(basal, 2, as.numeric) # numerico
basal_numeric <- as.data.frame(basal_numeric) #df
rownames(basal_numeric) <- rownames(basal) # rownames

medias_basal <- apply(basal_numeric, 2, mean) # media
medias_basal <- as.data.frame(medias_basal)

post_numeric <- apply(post, 2, as.numeric)
post_numeric <- as.data.frame(post_numeric)
rownames(post_numeric) <- rownames(post)

medias_post <- apply(post_numeric, 2, mean)
medias_post <- as.data.frame(medias_post)

rec_numeric <- apply(rec, 2, as.numeric)
rec_numeric <- as.data.frame(rec_numeric)
rownames(rec_numeric) <- rownames(rec)

medias_rec <- apply(rec_numeric, 2, mean)
medias_rec <- as.data.frame(medias_rec)

probando1 <- cbind(medias_basal,medias_post)
union_medias <- cbind(probando1, medias_rec)

# FC
fc_basal_post <- as.data.frame(log2(union_medias$medias_basal/union_medias$medias_post))
rownames(fc_basal_post) <- rownames(medias_basal)
fc_basal_rec <- as.data.frame(log2(union_medias$medias_basal/union_medias$medias_rec))
rownames(fc_basal_rec) <- rownames(medias_basal)
fc_post_rec <- as.data.frame(log2(union_medias$medias_post/union_medias$medias_rec))
rownames(fc_post_rec) <- rownames(medias_basal)

# Se crea la tabla en la que se incluyen los FC y los p-valores

fc_bp_in2 <- as.data.frame(fc_basal_post[rownames(fc_basal_post) %in% rownames(wilcox_prueba2_df),])
rownames(fc_bp_in2) <- rownames(wilcox_prueba2_df)
results2 <- cbind(fc_bp_in2, wilcox_prueba2_df$V1)
colnames(results2) <- c("log2FC", "pval")

fc_br_in2 <- as.data.frame(fc_basal_rec[rownames(fc_basal_rec) %in% rownames(wilcox_prueba2_df),])
rownames(fc_br_in2) <- rownames(wilcox_prueba2_df)
results3 <- cbind(fc_br_in2, wilcox_prueba2_df$V2)
colnames(results3) <- c("log2FC", "pval")

fc_pr_in2 <- as.data.frame(fc_post_rec[rownames(fc_post_rec) %in% rownames(wilcox_prueba2_df),])
rownames(fc_pr_in2) <- rownames(wilcox_prueba2_df)
results4 <- cbind(fc_pr_in2, wilcox_prueba2_df$V4)
colnames(results4) <- c("log2FC", "pval")

#### TOP TABLES (GENES) ####

wil_basal_rec$code <- rownames(wil_basal_rec)
wil_basal_rec3 <- as.data.frame(wil_basal_rec[order(wil_basal_rec$wil2),])
basal_rec_top50 <- wil_basal_rec3[1:50,]

wil_basal_post$code <- rownames(wil_basal_post)
wil_basal_post2 <- as.data.frame(wil_basal_post[order(wil_basal_post$wil),])
basal_post_top50 <- wil_basal_post2[1:50,]

wil_post_rec$code <- rownames(wil_post_rec)
wil_post_rec2 <- as.data.frame(wil_post_rec[order(wil_post_rec$wil3),])
post_rec_top50 <- wil_post_rec2[1:50,]

#### COMUNES DEL TOP 50 ####
comunes1 <- as.data.frame(basal_rec_top50[rownames(basal_rec_top50) %in% rownames(basal_post_top50),])
comunes2 <- as.data.frame(basal_rec_top50[rownames(basal_rec_top50) %in% rownames(post_rec_top50),])
comunes3 <- as.data.frame(basal_post_top50[rownames(basal_post_top50) %in% rownames(post_rec_top50),])

#### FC SIGNIFICATIVOS ####

# BP
fc_bp_in <- as.data.frame(fc_basal_post[rownames(fc_basal_post) %in% rownames(wil_basal_post),])
rownames(fc_bp_in) <- rownames(wil_basal_post)
barplot(sort(fc_bp_in$fc_basal_post[rownames(fc_basal_post) %in% rownames(wil_basal_post), ], decreasing=T))
colnames(fc_bp_in) <- c("log2FC")
fc_bp_in$codes <- rownames(fc_bp_in)
fc_bp_wil <- cbind(fc_bp_in, wil_basal_post$wil)
fc_bp_wil$diffexpressed <- "NO"
fc_bp_wil$diffexpressed[fc_bp_wil$log2FC > 1 & fc_bp_wil$`wil_basal_post$wil` < 0.05] <- "UP"
fc_bp_wil$diffexpressed[fc_bp_wil$log2FC < -1 & fc_bp_wil$`wil_basal_post$wil` < 0.05] <- "DOWN"
fc_bp_wil_updown <- fc_bp_wil[fc_bp_wil$diffexpressed != "NO",]

# BR
fc_br_in <- as.data.frame(fc_basal_rec[rownames(fc_basal_rec) %in% rownames(wil_basal_rec),])
rownames(fc_br_in) <- rownames(wil_basal_rec)
colnames(fc_br_in) <- c("log2FC")
fc_br_in$codes <- rownames(fc_br_in)
fc_br_wil <- cbind(fc_br_in, wil_basal_rec$wil2)
fc_br_wil$diffexpressed <- "NO"
fc_br_wil$diffexpressed[fc_br_wil$log2FC > 1 & fc_br_wil$`wil_basal_rec$wil2` < 0.05] <- "UP"
fc_br_wil$diffexpressed[fc_br_wil$log2FC < -1 & fc_br_wil$`wil_basal_rec$wil2` < 0.05] <- "DOWN"
fc_br_wil_updown <- fc_br_wil[fc_br_wil$diffexpressed != "NO",]

# PR
fc_pr_in <- as.data.frame(fc_post_rec[rownames(fc_post_rec) %in% rownames(wil_post_rec),])
rownames(fc_pr_in) <- rownames(wil_post_rec)
colnames(fc_pr_in) <- c("log2FC")
fc_pr_in$codes <- rownames(fc_pr_in)
fc_pr_wil <- cbind(fc_pr_in, wil_post_rec$wil3)
fc_pr_wil$diffexpressed <- "NO"
fc_pr_wil$diffexpressed[fc_pr_wil$log2FC > 1 & fc_pr_wil$`wil_post_rec$wil3` < 0.05] <- "UP"
fc_pr_wil$diffexpressed[fc_pr_wil$log2FC < -1 & fc_pr_wil$`wil_post_rec$wil3` < 0.05] <- "DOWN"
fc_pr_wil_updown <- fc_pr_wil[fc_pr_wil$diffexpressed != "NO",]

##### VOLCANO PLOTS ####
library(ggplot2)

# BP

results2$diffexpressed <- "NO"
results2$diffexpressed[results2$log2FC > 1 & results2$pval < 0.05] <- "UP"
results2$diffexpressed[results2$log2FC < -1 & results2$pval < 0.05] <- "DOWN"

volcano1.1 <- ggplot(data=results2, aes(x=log2FC, y=-log10(pval), col="blue")) + geom_point() + theme_minimal()
volcano1.2 <- volcano1.1 + geom_vline(xintercept=c(-0.6, 0.6), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red")
volcano1.3 <- volcano1.2 + scale_color_manual(values=c("blue", "black", "red"))
mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")
volcano1.3 <- volcano1.2 + scale_colour_manual(values = mycolors)

results2$delabel <- NA
results2$delabel[results2$diffexpressed != "NO"] <- rownames(results2)[results2$diffexpressed != "NO"]

ggplot(data=results2, aes(x=log2FC, y=-log10(pval), label = delabel)) + 
  geom_point(color = "blue") + 
  theme_minimal() +
  geom_text() +
  ggtitle("Basal vs Post")

ggplot(data=results3, aes(x=log2FC, y=-log10(pval), label = delabel)) + 
  geom_point(color = "green") + 
  theme_minimal() +
  geom_text() +
  ggtitle("Basal vs Recovery")

ggplot(data=results4, aes(x=log2FC, y=-log10(pval), label = delabel)) + 
  geom_point(color = "orange") + 
  theme_minimal() +
  geom_text() +
  ggtitle("Post vs Recovery")

# BR

results3$diffexpressed <- "NO"
results3$diffexpressed[results3$log2FC > 1] <- "UP"
results3$diffexpressed[results3$log2FC < -1] <- "DOWN"

volcano2.1 <- ggplot(data=results3, aes(x=log2FC, y=-log10(pval), col=diffexpressed)) + geom_point() + theme_minimal()
volcano2.2 <- volcano2.1 + geom_vline(xintercept=c(-0.5, 0.5), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red")
volcano2.3 <- volcano2.2 + scale_color_manual(values=c("blue", "black", "red"))
volcano2.3 <- volcano2.2 + scale_colour_manual(values = mycolors)

results3$delabel <- NA
results3$delabel[results3$diffexpressed != "NO"] <- rownames(results3)[results3$diffexpressed != "NO"]

ggplot(data=results3, aes(x=log2FC, y=-log10(pval), col=diffexpressed, label=delabel)) + 
  geom_point() + 
  theme_minimal() +
  geom_text() +
  ggtitle("Basal vs Recovery")

# PR

results4$diffexpressed <- "NO"
results4$diffexpressed[results4$log2FC > 1 & results4$pval < 0.05] <- "UP"
results4$diffexpressed[results4$log2FC < -1 & results4$pval < 0.05] <- "DOWN"

volcano3.1 <- ggplot(data=results4, aes(x=log2FC, y=-log10(pval), col=diffexpressed)) + geom_point() + theme_minimal()
volcano3.2 <- volcano3.1 + geom_vline(xintercept=c(-0.5, 0.5), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red")
volcano3.3 <- volcano3.2 + scale_color_manual(values=c("blue", "black", "red"))
volcano3.3 <- volcano3.2 + scale_colour_manual(values = mycolors)

results4$delabel <- NA
results4$delabel[results4$diffexpressed != "NO"] <- rownames(results4)[results4$diffexpressed != "NO"]

ggplot(data=results4, aes(x=log2FC, y=-log10(pval), col=diffexpressed, label=delabel)) + 
  geom_point() + 
  theme_minimal() +
  geom_text() +
  ggtitle("Post vs Recovery")

#### UP, DOWN Y DE ####

# BP
sum(results2$diffexpressed=="UP")
sum(results2$diffexpressed=="DOWN")
sum(results2$diffexpressed=="NO")

# BR
sum(results3$diffexpressed=="UP")
sum(results3$diffexpressed=="DOWN")
sum(results3$diffexpressed=="NO")

#PR
sum(results4$diffexpressed=="UP")
sum(results4$diffexpressed=="DOWN")
sum(results4$diffexpressed=="NO")

##### GO ENRICHMENT ####
# BP
# Se seleccionan los codigos y se les quita lo que venga despues del punto

library(clusterProfiler)
library(org.Hs.eg.db)
library(AnnotationDbi)
library(DOSE)
genes_to_test <- rownames(fc_bp_wil_updown) #sacamos los genes con log2FC mayor que 0.5
library(stringr)
cortados <- str_sub(genes_to_test,1,nchar(genes_to_test)-2)
eliminar_punto <- gsub('\\.', '', cortados)
head(eliminar_punto)
eliminar_punto_new <- eliminar_punto[1:17]
sybols_bp$Symbol

GO_results_bp <- enrichGO(gene = eliminar_punto, OrgDb = "org.Hs.eg.db", keyType = "ENSEMBL", ont = "BP") # Extraemos su GO
GO_results_bp_df <- as.data.frame(GO_results_bp)

fit_bp <- plot(barplot(GO_results_bp, showCategory = 25, font.size=3, title = "Go Enrichment BP - Top 25")) # showcategory cuantos queremos mostrar
fit_bp
png("BP_GO_25.png", res = 250, width = 1200, height = 1000)
print(fit_bp)
dev.off()
fit_bp2 <- plot(barplot(GO_results_bp, showCategory = 50, font.size=3, title = "GO Enrichment BP - Top 50")) # showcategory cuantos queremos mostrar
fit_bp2
png("BP_GO_50.png", res = 250, width = 1200, height = 1000)
print(fit_bp2)
dev.off()

# BR

genes_to_test_br <- rownames(fc_br_wil_updown)
cortados2 <- str_sub(genes_to_test_br,1,nchar(genes_to_test_br)-2)
eliminar_punto2 <- gsub('\\.', '', cortados2)
head(eliminar_punto2)

# Se eliminan dos codigos que no presentan codigo al ser novel o no hay referencias
# Se abre el archivo eliminarpunto2 symbols2

write(eliminar_punto2, "elimiando2.csv")
symbols2 <- read_csv("elimiando2.csv")
GO_results_br <- enrichGO(gene = symbols2$Codes, OrgDb = "org.Hs.eg.db", keyType = "ENSEMBL", ont = "BP") # Extraemos su GO
GO_results_br_df2 <- as.data.frame(GO_results_br)

fit_br <- plot(barplot(GO_results_br, showCategory = 25, font.size=3, title = "GO Enrichment BR - Top 25")) # showcategory cuantos queremos mostrar
fit_br
png("BR_GO_25.png", res = 250, width = 1200, height = 1000)
print(fit_br)
dev.off()
fit_br2 <- plot(barplot(GO_results_br, showCategory = 50)) # showcategory cuantos queremos mostrar
fit_br2
png("BR_GO_50.png", res = 250, width = 1200, height = 1000)
print(fit_br2)
dev.off()

# PR

genes_to_test_pr <- rownames(fc_pr_wil_updown) #sacamos los genes con log2FC mayor que 0.5
cortados3 <- str_sub(genes_to_test_pr,1,nchar(genes_to_test_pr)-2)
eliminar_punto3 <- gsub('\\.', '', cortados3)
head(eliminar_punto3)
GO_results_pr <- enrichGO(gene = eliminar_punto3, OrgDb = "org.Hs.eg.db", keyType = "ENSEMBL", ont = "BP") # Extraemos su GO
GO_results_pr_df <- as.data.frame(GO_results_pr)
fit_pr <- plot(barplot(GO_results_pr, showCategory = 25, font.size = 3, title = "GO Enrichment PR - Top 25")) # showcategory cuantos queremos mostrar
fit_pr
png("PR_GO_25.png", res = 250, width = 1200, height = 1000)
print(fit_pr)
dev.off()
fit_pr2 <- plot(barplot(GO_results_pr, showCategory = 50)) # showcategory cuantos queremos mostrar
fit_pr2
png("PR_GO_50.png", res = 250, width = 1200, height = 1000)
print(fit_pr2)
dev.off()
#### KEGG ####
library(pathview)
library(gage)
library(gageData)

# Se extraen los codigos de los genes para introducirlos en DAVID
codigos_result2 <- rownames(results2)
cut_1 <- str_sub(codigos_result2,1,nchar(codigos_result2)-2)
delete_1 <- gsub('\\.', '', cut_1)
write.csv(delete_1, "codes_id_bp.csv")

codigos_result3 <- rownames(results3)
cut_2 <- str_sub(codigos_result3,1,nchar(codigos_result3)-2)
delete_2 <- gsub('\\.', '', cut_2)
write.csv(delete_2, "codes_id_br.csv")

codigos_result4 <- rownames(results4)
cut_3 <- str_sub(codigos_result4,1,nchar(codigos_result4)-2)
delete_3 <- gsub('\\.', '', cut_3)
write.csv(delete_3, "codes_id_pr.csv")

# Códigos KEGG

write(eliminar_punto, "kegg_bp.csv")
write(eliminar_punto2, "kegg_br.csv")
write(eliminar_punto3, "kegg_pr.csv")


#### SE EXTRAEN LOS COMUNES Y SE COMPRUEBAN EN QUE MOMENTO SE EXPRESAN ####

bp_grupo1 <- basal_post_top50[basal_post_top50$code %in% comunes1$code,]
br_grupo1 <- basal_rec_top50[basal_rec_top50$code %in% comunes1$code,]
bp_br_grupo1 <- cbind(bp_grupo1, br_grupo1)

br_grupo2 <- basal_rec_top50[basal_rec_top50$code %in% comunes2$code,]
pr_grupo2 <- post_rec_top50[post_rec_top50$code %in% comunes2$code,]
br_pr_grupo2 <- cbind(br_grupo2, pr_grupo2)

bp_grupo3 <- basal_post_top50[basal_post_top50$code %in% comunes3$code,]
pr_grupo3 <- post_rec_top50[post_rec_top50$code %in% comunes3$code,]
bp_pr_grupo3 <- cbind(bp_grupo3, pr_grupo3)